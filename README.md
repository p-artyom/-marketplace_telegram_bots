# Маркетплейс _Telegram_ ботов

## Описание

Маркетплейс _Telegram_ ботов для ритейла представляет собой веб-приложение
позволяющее пользователю покупать и продавать _Telegram_ боты в рамках
торговой интернет-площадки. Основная функциональность приложения (покупка и
продажа) происходит посредством авторизации пользователя в системе и
последующего взаимодействия с личным кабинетом, страницей продавца, корзиной и
каталогом ботов.

## Технологии

- Python 3.10.12;
- PostgreSQL 14;
- Django 4.2.5;
- Django REST framework 3.14.0;
- Gunicorn 21.2.0;
- Nginx 1.22.1.

## Деплой проекта на удалённый сервер

Инструкция написана для сервера с установленной _ОС Ubuntu 22.04.1 LTS_.

- Подключитесь к удалённому серверу;

- Установите _Docker Compose_ на сервер. Поочерёдно выполните на сервере
команды для установки _Docker_ и _Docker Compose_ для _Linux_. Выполнять их
лучше в домашней директории пользователя:

```text
sudo apt update
sudo apt install curl
curl -fSL https://get.docker.com -o get-docker.sh
sudo sh ./get-docker.sh
sudo apt-get install docker-compose-plugin
```

- Находясь на удалённом сервере, из любой директории выполните команду:

```text
sudo apt install nginx -y
```

- А потом запустите _Nginx_ командой:

```text
sudo systemctl start nginx
```

- На сервере в редакторе _nano_ откройте конфиг _Nginx_:
`sudo nano /etc/nginx/sites-enabled/default`. Измените настройки `location`
в секции `server`:

```text
location / {
    proxy_set_header Host $http_host;
    proxy_pass http://127.0.0.1:8000;
}
```

- Для проверки файла конфигурации на ошибки выполните команду:

```text
sudo nginx -t
```

- Далее перезагрузите конфигурацию _Nginx_:

```text
sudo systemctl reload nginx
```

- В домашней директории на удалённом сервере создайте папку с названием
`marketplace`;

- Внутри папки `marketplace` создайте `.env` файл и заполните следующими
данными:

  - в переменную `USE_SQLITE` укажите _True_, если хотите использовать БД
  _SQLite_, _False_, если хотите использовать БД _PostgreSQL_;

  - в переменной `POSTGRES_DB` должно быть название базы данных;

  - в переменной `POSTGRES_USER` должно быть имя пользователя БД;

  - в переменной `POSTGRES_PASSWORD` должен быть пароль пользователя БД;

  - в переменной `DB_HOST` должен быть адрес, по которому _Django_ будет
  соединяться с базой данных;

  - в переменной `DB_PORT` должен быть порт, по которому _Django_ будет
  обращаться к базе данных;

  - в переменную `SECRET_KEY` укажите секретный ключ для конкретной установки
  _Django_;

  - в переменную `DEBUG` укажите значение режима отладки;

  - в переменную `ALLOWED_HOSTS` укажите список строк, представляющих имена
  хоста/домена, которые может обслуживать это _Django_ приложение.

- Форкните и клонируйте к себе на компьютер
[репозиторий](https://github.com/p-artyom/marketplace_telegram_bots) (при
клонировании необходимо добавить опцию `--recurse-submodule`);

- В корне проекта создайте директорию `.github/workflows`, а в ней - файл
`main.yml`;

- Скопируйте содержимое файла `marketplace_workflows.yml` в `main.yml`;

- В файле `main.yml` в строках `78, 101` замените `<your_login>` на свой
логин в _DockerHub_;

- В файле `docker-compose.production.yml` в строках `15, 23` замените
`<your_login>` на свой логин в _DockerHub_;

- В директории `nginx` в файле `nginx.conf` замените `<ваш домен> <ваш IP>`
на свой домен и _IP_ удалённого сервера.

Для автоматического развёртывания контейнеров на удалённом сервере при помощи
_GitHub Actions_ необходимо создать _secrets_ в собственном репозитории.

- Перейдите в настройки репозитория — _Settings_, выберите на панели слева
_Secrets and Variables_ → _Actions_, нажмите _New repository secret_ и
создайте следующие переменные с необходимыми значениями:

  - в переменной `DOCKER_USERNAME` введите имя пользователя в _Docker Hub_;

  - в переменной `DOCKER_PASSWORD` введите пароль пользователя в _Docker Hub_;

  - в переменной `SSH_KEY` должно быть содержимое файла с закрытым _SSH_-ключом
  для доступа к серверу;

  - в переменной `SSH_PASSPHRASE` должно быть значение _passphrase_ для
  доступа к серверу;

  - в переменной `USER` должно быть ваше имя пользователя на сервере;

  - в переменной `HOST` должно быть значение _IP_-адреса вашего сервера.

- Сделайте коммит и запушьте изменения на _GitHub_;

- Пуш в ветку _main_ запускает тестирование и деплой маркетплейса _Telegram_
ботов на удалённый сервер.

Текущий _Workflow_ состоит из трёх фаз:

- Тестирование проекта;

- Сборка и публикация образа;

- Автоматический деплой.

## Запуск приложения локально в _docker_-контейнерах

Инструкция написана для компьютера с установленной _ОС Windows_ 10 или 11.

- Установите _Windows Subsystem for Linux_ по инструкции с официального сайта
[Microsoft](https://learn.microsoft.com/ru-ru/windows/wsl/install);

- Зайдите на
[официальный сайт Docker](https://www.docker.com/products/docker-desktop/),
скачайте и установите файл _Docker Desktop_;

- В корне репозитория создайте `.env` файл и заполните следующими
данными:

  - в переменную `USE_SQLITE` укажите _True_, если хотите использовать БД
  _SQLite_, _False_, если хотите использовать БД _PostgreSQL_;

  - в переменной `POSTGRES_DB` должно быть название базы данных;

  - в переменной `POSTGRES_USER` должно быть имя пользователя БД;

  - в переменной `POSTGRES_PASSWORD` должен быть пароль пользователя БД;

  - в переменной `DB_HOST` должен быть адрес, по которому _Django_ будет
  соединяться с базой данных;

  - в переменной `DB_PORT` должен быть порт, по которому _Django_ будет
  обращаться к базе данных;

  - в переменную `SECRET_KEY` укажите секретный ключ для конкретной установки
  _Django_;

  - в переменную `DEBUG` укажите значение режима отладки;

  - в переменную `ALLOWED_HOSTS` укажите список строк, представляющих имена
  хоста/домена, которые может обслуживать это _Django_ приложение.

- В терминале в папке с `docker-compose.yml` выполните команду:

```text
docker compose up
```

- Перейдите в новом терминале в директорию, где лежит файл
`docker-compose.yml`, и выполните команды:

```text
docker compose exec backend python manage.py migrate
docker compose exec backend python manage.py collectstatic
docker compose exec backend cp -r /app/collected_static/. /backend_static/static/
```

- Для создания суперпользователя используйте команду:

```text
docker compose exec backend python manage.py createsuperuser
```

- Панель администратора доступна по адресу `http://127.0.0.1:8000/admin/`;

- На странице `http://127.0.0.1:8000/docs/` можно ознакомиться с
документацией проекта.

## Автор

Пилипенко Артем
